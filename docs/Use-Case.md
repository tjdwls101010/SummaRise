# 콘텐츠 요약 애플리케이션 유스케이스 명세서

이 문서는 콘텐츠 요약 애플리케이션의 기능적 요구사항, 사용자 상호작용, 시스템 동작을 정의하는 유스케이스 명세서입니다. CTO와의 협업을 통해 기술적 관점과 사용자 경험을 모두 고려하여 작성되었습니다.

-----

### 액터 정의

  - **사용자 (User)**
      - 사이트의 단일 소유자. 시스템의 모든 기능을 사용할 수 있는 주체.
  - **웹 앱 (Web App - Next.js)**
      - 사용자 인터페이스(UI) 및 클라이언트 측 로직을 담당. 사용자의 입력을 받아 백엔드와 통신.
  - **요약 API 레이어 (Summarization API Layer)**
      - 콘텐츠 추출(YouTube, MarkItDown), LLM 호출, 데이터베이스 저장 등 핵심 비즈니스 로직을 조율(Orchestration)하는 백엔드 서버.
  - **LLM 제공자 (LLM Provider(s))**
      - 텍스트 요약을 수행하는 대규모 언어 모델 API. 기본으로 Gemini를 사용하며, 여러 API 키를 우선순위에 따라 관리하고 장애 발생 시 대체(Fail-over) 작동.
  - **YouTube 데이터 (YouTube Data)**
      - YouTube API를 통해 접근하는 영상의 메타데이터(제목, 채널명) 및 자막(Captions).
  - **MarkItDown 서비스 (MarkItDown Service)**
      - 웹 페이지의 HTML 콘텐츠를 LLM이 이해하기 쉬운 마크다운(Markdown) 형식으로 변환하는 외부 또는 내부 서비스.
  - **Supabase**
      - 데이터 저장을 위한 PostgreSQL 데이터베이스 및 백엔드 서비스. 본 프로젝트에서는 RLS(Row-Level Security)를 비활성화하고 서버 간 통신에 사용.

### 유스케이스 시나리오

  - **UC-01: URL 제출 및 요약**
      - 사용자가 웹 페이지나 YouTube 영상 URL을 제출하여 요약본을 생성하고 라이브러리에 저장합니다.
  - **UC-02: 라이브러리 조회 (갤러리/리스트)**
      - 사용자가 저장된 모든 요약 항목을 갤러리 또는 리스트 형태로 조회합니다.
  - **UC-03: 상세 페이지 열기**
      - 사용자가 라이브러리에서 특정 항목을 클릭하여 원본, 요약본, 태그 등 상세 정보를 확인합니다.
  - **UC-04: 항목 재요약**
      - 사용자가 기존에 요약된 항목을 현재의 시스템 프롬프트를 사용하여 다시 요약합니다.
  - **UC-05: Diff를 통한 요약 편집**
      - 사용자가 재요약 결과를 이전 요약본과 비교(Diff)하며 직접 수정하고 저장합니다.
  - **UC-06: 전문 검색 (Full-text Search)**
      - 사용자가 키워드를 입력하여 라이브러리 내 모든 콘텐츠(제목, 요약, 원본, 태그 등)를 검색합니다.
  - **UC-07: 시스템 프롬프트 및 태그 규칙 관리**
      - 사용자가 LLM에 전달될 기본 프롬프트와 요약 결과에서 태그를 자동 추출하는 규칙을 설정합니다.
  - **UC-08: LLM API 키 및 우선순위 관리**
      - 사용자가 여러 LLM 제공자의 API 키를 등록하고, 호출 우선순위를 설정하며, 활성화/비활성화합니다.

### 주요 단계 및 이벤트 흐름

#### UC-01: URL 제출 및 요약

1.  **사용자 행동:** 메인 페이지의 입력 필드에 YouTube 영상 또는 웹 페이지 URL을 입력하고 '요약하기' 버튼을 클릭합니다.
2.  **시스템 상태:**
      - 웹 앱이 URL 형식의 유효성을 클라이언트 단에서 검사합니다.
      - 유효한 URL을 '요약 API 레이어'로 전송합니다. API 레이어는 요청을 수신하고 처리 상태를 '진행 중'으로 설정합니다.
      - API 레이어는 URL을 분석하여 'youtube' 또는 'webpage'로 `content_type`을 결정합니다.
      - **YouTube의 경우:** YouTube Data API를 호출하여 영상 제목, 채널명, 자막 트랜스크립트를 가져옵니다.
      - **웹페이지의 경우:** 해당 URL의 HTML을 가져온 후, MarkItDown 서비스를 호출하여 본문을 마크다운으로 변환합니다.
      - 추출된 텍스트(자막 또는 마크다운)를 '시스템 프롬프트'와 결합하여 'LLM 제공자'에게 요약 요청을 보냅니다.
      - LLM으로부터 요약된 텍스트(`summarized_content`)를 수신합니다.
      - 설정된 '태그 규칙'에 따라 요약 결과에서 태그를 자동 추출합니다.
      - 최종 데이터를 (`id`, `source_url`, `title`, `original_content` 등) Supabase 데이터베이스에 저장합니다.
      - 웹 앱에 요약 성공 및 생성된 항목 데이터를 전달합니다.
3.  **사용자 행동:** 웹 앱 UI가 실시간으로 업데이트되어, 라이브러리 상단에 새로 생성된 요약 항목이 표시됩니다.

<!-- end list -->

  - **Verification:** Supabase `summaries` 테이블에 `id, created_at, source_url, content_type, title, channel_or_site, original_content, summarized_content, tags[]` 스키마에 맞는 새 레코드가 생성되었는지 확인합니다.

#### UC-04: 항목 재요약

1.  **사용자 행동:** 상세 페이지에서 '재요약' 버튼을 클릭합니다.
2.  **시스템 상태:**
      - 웹 앱이 해당 항목의 `id`와 원본 콘텐츠(`original_content`)를 '요약 API 레이어'로 전송합니다.
      - API 레이어는 현재 설정된 '시스템 프롬프트'를 데이터베이스에서 조회합니다.
      - 조회된 프롬프트와 원본 콘텐츠를 결합하여 'LLM 제공자'에게 요약 요청을 다시 보냅니다.
      - 새로운 요약 결과를 수신합니다.
      - 웹 앱으로 새로운 요약 결과를 전달합니다. 기존 요약 결과는 임시로 보관됩니다.
3.  **사용자 행동:** UI에 이전 요약본과 새 요약본을 나란히 비교하는 Diff 뷰가 표시됩니다.

<!-- end list -->

  - **Verification:** 새로운 요약 요청이 현재 시스템 프롬프트를 사용하여 LLM에 전달되는지 로그를 통해 확인합니다.

#### UC-06: 전문 검색

1.  **사용자 행동:** 상단의 검색 바에 검색어를 입력합니다. 입력하는 동안 실시간으로 검색 결과가 나타납니다.
2.  **시스템 상태:**
      - 웹 앱이 입력된 검색어를 `debounce` 처리하여 불필요한 API 호출을 최소화한 후, '요약 API 레이어'로 검색 요청을 보냅니다.
      - API 레이어는 Supabase의 Full-Text Search 기능을 사용하여 `title`, `summarized_content`, `original_content`, `tags`, `channel_or_site` 필드에서 검색어와 일치하는 항목을 조회합니다.
      - 검색 결과를 관련도 순으로 정렬하여 웹 앱에 반환합니다.
3.  **사용자 행동:** 라이브러리 뷰가 검색 결과와 일치하는 항목들로 필터링되어 표시됩니다.

<!-- end list -->

  - **Verification:** 검색어가 포함된 항목이 제목, 본문, 태그 등 다양한 필드에서 정확히 조회되는지 확인합니다.

### 대안 흐름 및 엣지 케이스

  - **자막 없는 YouTube 영상 (UC-01):**
      - 시스템이 YouTube 자막을 가져오려 시도했으나 실패하면, 요약 프로세스를 중단하고 사용자에게 "자막이 없는 영상은 요약할 수 없습니다." 라는 메시지를 표시합니다.
  - **빈 콘텐츠 페이지 (UC-01):**
      - MarkItDown 서비스가 웹페이지에서 유의미한 텍스트를 추출하지 못하고 빈 값을 반환하면, 프로세스를 중단하고 "페이지에서 콘텐츠를 추출할 수 없습니다." 라는 메시지를 표시합니다.
  - **LLM API 실패 (UC-01, UC-04):**
      - LLM API 호출이 Rate Limit, 인증 실패 등의 이유로 실패하면, 시스템은 자동으로 다음 우선순위의 API 키로 전환하여 재시도합니다. 모든 키가 실패하면 사용자에게 서비스 실패 메시지를 표시합니다.
  - **요약 시간 초과 (UC-01, UC-04):**
      - 요약 프로세스가 30초를 초과하면, 시스템은 요청을 타임아웃 처리하고 "요약 작업이 너무 오래 걸립니다." 라는 메시지를 사용자에게 표시합니다.

### 사전 조건 및 사후 조건

  - **일반 사전 조건**
      - 사용자는 애플리케이션에 접근 가능해야 합니다.
      - 웹 앱, API 레이어, 데이터베이스 등 모든 시스템 구성 요소가 정상적으로 실행 중이어야 합니다.
      - 최소 1개 이상의 유효한 LLM API 키가 시스템에 등록되어 있어야 합니다.
  - **UC-01: URL 제출 및 요약**
      - **사전 조건:** 사용자가 요약하고자 하는 유효한 URL을 알고 있습니다.
      - **사후 조건:** 새로운 요약 항목이 데이터베이스에 성공적으로 저장되고 사용자 라이브러리에 표시됩니다. 또는, 실패 시 명확한 오류 메시지가 사용자에게 전달됩니다.
  - **UC-05: Diff를 통한 요약 편집**
      - **사전 조건:** 항목이 최소 1회 이상 재요약되어 비교할 대상이 존재합니다.
      - **사후 조건:** 사용자가 수정한 내용이 `summarized_content` 필드에 최종적으로 업데이트됩니다.

### 비즈니스 규칙 및 제약 조건

  - 시스템은 단일 사용자를 대상으로 하므로, 별도의 로그인/회원가입 기능은 구현하지 않습니다.
  - 데이터베이스는 `id, created_at, source_url, content_type, title, channel_or_site, original_content, summarized_content, tags[]` 스키마를 준수해야 합니다.
  - 요약본 비교(Diff) 기능은 항상 가장 마지막(이전) 요약본과 현재 생성된 요약본 간의 차이점만 표시합니다.
  - 전문 검색은 제목, 요약본, 원본, 태그, 출처, 날짜(생성일 기준 필터링) 필드를 대상으로 수행되어야 합니다.
  - 핵심 성능 지표인 'Time-to-summary'(URL 제출부터 요약 결과 표시까지의 시간)는 P95(95th percentile) 기준 30초를 넘지 않아야 합니다.
  - LLM API 호출 실패 시, 시스템은 사전에 정의된 우선순위에 따라 다음 API 키로 자동 대체하여 요청을 재시도해야 합니다.

### 예외 처리 절차

| 조건 (Condition) | 조치 (Action) |
| --- | --- |
| YouTube 영상에 자막 없음 | 1. 사용자에게 "자막이 없는 영상은 요약할 수 없습니다." 알림 표시.\<br\>2. 프로세스를 정상적으로 종료. |
| 동적 웹페이지가 빈 HTML 반환 | 1. 사용자에게 "콘텐츠를 가져올 수 없는 페이지입니다. 정적 콘텐츠가 있는 페이지를 시도해주세요." 알림 표시.\<br\>2. 프로세스 종료. |
| LLM Rate-Limit 또는 API 키 오류 | 1. 현재 API 키를 '실패'로 임시 마킹.\<br\>2. 다음 우선순위의 API 키로 자동 전환하여 재시도 (최대 3회).\<br\>3. 모든 키 실패 시, 사용자에게 "요약 서비스에 일시적인 문제가 발생했습니다." 알림 표시 및 관리자에게 로그 전송. |
| Supabase 쓰기/읽기 오류 | 1. 내부적으로指数退避(Exponential Backoff)을 적용하여 몇 차례 재시도.\<br\>2. 최종 실패 시, 사용자에게 "데이터베이스 오류가 발생했습니다." 알림 표시 및 관리자에게 실패 로그(쿼리 포함) 전송. |
| 요약 작업 시간 초과 (\> 30초) | 1. 해당 요청 프로세스를 타임아웃 처리하고 중단.\<br\>2. 사용자에게 "요약 작업이 시간 초과되었습니다. 대상 콘텐츠가 너무 길거나 서비스에 부하가 많을 수 있습니다." 알림 표시.\<br\>3. 관리자에게 타임아웃 로그(URL, 처리 시간) 전송. |

### 사용자 인터페이스 고려사항

  - **피드백 및 상태 표시:** 요약이 진행 중일 때, 버튼을 비활성화하고 로딩 스피너를 표시하여 사용자가 시스템 상태를 명확히 인지하게 합니다.
  - **낙관적 UI (Optimistic UI):** '요약하기' 버튼을 누르면 즉시 라이브러리에 회색 처리된 플레이스홀더 카드를 생성하고, 요약이 완료되면 내용을 채워넣어 시스템이 즉각적으로 반응하는 것처럼 느끼게 합니다.
  - **오류 메시지:** "Error code 500"과 같은 기술적인 메시지 대신 "서버에 문제가 발생하여 요청을 처리할 수 없습니다." 와 같이 사용자가 이해하고 조치할 수 있는 친절한 언어로 안내합니다.
  - **Diff 뷰어:** `react-diff-viewer`와 같은 검증된 라이브러리를 사용하여, 가독성이 높은 Side-by-Side 또는 Inline 방식의 비교 뷰를 제공합니다. 변경 사항은 명확한 색상으로 하이라이트합니다.
  - **일관성 있는 디자인:** 모든 페이지와 컴포넌트에서 일관된 디자인 언어(색상, 폰트, 아이콘, 레이아웃)를 사용하여 학습 비용을 줄이고 사용성을 높입니다.

### 데이터 요구사항 및 데이터 흐름

#### 데이터 모델 (Supabase `summaries` 테이블)

  - `id` (UUID, PK): 레코드의 고유 식별자
  - `created_at` (TimestampTZ): 레코드 생성 시각
  - `source_url` (Text, Not Null): 원본 콘텐츠의 URL
  - `content_type` (Enum: 'youtube', 'webpage'): 콘텐츠 유형
  - `title` (Text): 추출된 영상/페이지의 제목
  - `channel_or_site` (Text): YouTube 채널명 또는 웹사이트의 도메인
  - `original_content` (Text): 추출된 원본 텍스트 (자막 또는 Markdown)
  - `summarized_content` (Text): LLM이 생성한 요약 텍스트
  - `tags` (TEXT[]): 자동 또는 수동으로 추가된 태그 배열

#### 데이터 흐름 (UC-01 기준)

1.  **User → Web App:** 사용자가 URL을 입력.
2.  **Web App → Summarization API Layer:** `{ "url": "..." }` 형태의 JSON을 POST 요청으로 전송.
3.  **Summarization API Layer → YouTube Data / MarkItDown:** URL 유형에 따라 외부 서비스/API를 호출하여 원본 콘텐츠(텍스트)를 가져옴.
4.  **Summarization API Layer → LLM Provider:** 시스템 프롬프트와 원본 콘텐츠를 결합하여 요약 요청.
5.  **LLM Provider → Summarization API Layer:** 요약된 텍스트를 응답으로 받음.
6.  **Summarization API Layer → Supabase:** 정제된 전체 데이터를 DB에 INSERT.
7.  **Supabase → Summarization API Layer:** 저장 성공 여부 및 생성된 `id`를 반환.
8.  **Summarization API Layer → Web App:** `{ "success": true, "data": { ... } }` 형태의 최종 결과를 전송.
9.  **Web App → User:** 수신한 데이터로 UI를 동적으로 업데이트.

### 보안 및 개인정보 보호 고려사항

  - **API 키 관리:** 모든 외부 서비스(LLM, YouTube)의 API 키는 서버(요약 API 레이어)의 환경 변수를 통해서만 관리됩니다. 클라이언트 코드에는 절대 노출되지 않습니다.
  - **데이터베이스 접근 제어:** Supabase는 "RLS-disabled private backend" 원칙에 따라, 모든 데이터베이스 통신은 백엔드 서버의 서비스 키를 통해서만 이루어져야 합니다. 클라이언트에서 Supabase JS 라이브러리를 통해 DB에 직접 접근하는 것을 금지합니다.
  - **입력값 검증 (Input Sanitization):** 사용자가 입력하는 URL, 검색어 등 모든 외부 입력값은 서버 단에서 검증 및 정제하여 XSS(Cross-Site Scripting), SQL Injection 등의 공격을 방지합니다.
  - **서비스 거부(DoS) 방지:** 악의적인 대량 요청을 막기 위해 API 엔드포인트에 IP 기반의 요청률 제한(Rate Limiting)을 적용합니다.
  - **콘텐츠 프라이버시:** 사용자가 요약하는 콘텐츠에 개인정보나 민감 정보가 포함될 수 있습니다. LLM 제공자의 데이터 사용 및 보관 정책을 명확히 인지해야 하며, 시스템은 해당 데이터를 별도로 저장하거나 분석하지 않습니다.